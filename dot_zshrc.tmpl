# ------------------------------
# Oh My Zsh
# ------------------------------
export ZSH="$HOME/.oh-my-zsh"
ZSH_THEME="robbyrussell"

plugins=(
	git
	zsh-syntax-highlighting
	zsh-autosuggestions
)

source $ZSH/oh-my-zsh.sh

# ------------------------------
# Prompt
# ------------------------------

# Show current Kubernetes context and namespace in prompt
source /opt/homebrew/opt/kube-ps1/share/kube-ps1.sh
PROMPT='$(kube_ps1)'$PROMPT

# ------------------------------
# Editor
# ------------------------------

# Use nvim locally, fall back to vim over SSH
if [[ -n $SSH_CONNECTION ]]; then
  export EDITOR='vim'
else
  export EDITOR='nvim'
fi

# ------------------------------
# Tools
# ------------------------------

# SDKMAN - Java SDK version manager
source "$HOME/.sdkman/bin/sdkman-init.sh"

# thefuck - command correction
eval $(thefuck --alias)

# fzf - fuzzy finder keybindings and completion
source <(fzf --zsh 2>/dev/null)

# Lazy-load kubectl completion to avoid Vault auth calls on shell startup
if [[ /opt/homebrew/bin/kubectl ]]; then
  kubectl() {
    unfunction kubectl
    source <(command kubectl completion zsh)
    command kubectl "$@"
  }
fi

# Google Cloud SDK - path and shell completion
if [ -f "$HOME/google-cloud-sdk/path.zsh.inc" ]; then . "$HOME/google-cloud-sdk/path.zsh.inc"; fi
if [ -f "$HOME/google-cloud-sdk/completion.zsh.inc" ]; then . "$HOME/google-cloud-sdk/completion.zsh.inc"; fi

# ------------------------------
# Environment variables
# ------------------------------

# LogScale / Humio
export HUMIO_API_TOKEN="{{ onepasswordRead "op://commercetools/HUMIO_API_TOKEN/password" }}"

# commercetools Homebrew tap token (via 1Password)
export HOMEBREW_GITHUB_API_TOKEN="{{ onepasswordRead "op://commercetools/HOMEBREW_GITHUB_API_TOKEN/password" }}"

# Atlassian API tokens (via macOS Keychain)
export JIRA_API_TOKEN="$(security find-generic-password -a "{{ .email }}" -s "atlassian_api_token" -w)"
export CONFLUENCE_API_TOKEN="$JIRA_API_TOKEN"

# ------------------------------
# PATH
# ------------------------------

export PATH="$HOME/bin:$PATH"              # tfswitch-managed terraform
export PATH="$HOME/.rd/bin:$PATH"          # Rancher Desktop
export PATH="$HOME/.local/bin:$PATH"       # User-local binaries

# ------------------------------
# Functions
# ------------------------------

# Append a task to the Obsidian vault todo file
function todo { echo "- [ ] #t $1" >> ~/Documents/Obsidian/Todo\ Source.md  }
